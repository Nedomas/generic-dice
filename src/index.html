<!doctype html>

<html lang="en">
<head>
<meta charset="utf-8">

<title>DICES!</title>

<meta name="description" content="A doce thrower prototype">
<meta name="author" content="Ernesto Paniagua">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

<link rel="stylesheet" href="./css/styles.css">
  
  <!--[if lt IE 9]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.js"></script>
  <![endif]-->
  
</head>

<body>
  
  <div id="results">
    <div id="results-pool"></div>
    <div id="game-result">·</div>
  </div>
  <div id="main-wrapper-shadows"></div>
  <div id="main-wrapper"></div>
  <!--  <div id="games-menu" class="c">
    <ul>
      <li id="game-1">The best out of X</li>
      <li id="game-2">Lucky Jackpots on 10 throws</li>
      <li id="game-3">Free game</li>
    </ul>
  </div> -->
  
  <script>
	
    (function(){
      

      var app = {};

      app.dicesAmount = 0;
      
      app.dicesResults = [];
      app.finalResult = 0;
      app.resultsPool = [];
      
      app.flying = false;
      
      app.randomFace = function(){
        return Math.ceil(Math.random()*6);
      };
      
      app.sum = function(arr){
        
        function getSum(total, num) {
            return total + num;
        }
        return arr.reduce(getSum);
        
      };
      
      app.reset = function(){
      
        this.dicesResults = [];
        this.finalResult = 0;
        document.getElementById('game-result').innerHTML = '×';
        var faces = document.getElementsByClassName('dice-face');
        for( var i=0, l = faces.length; i < l ; i++ ){
          
          faces[i].style.display = 'none';
          
        };

      };

      app.createDiceIn = function(container){

          var html = '';

          this.dicesAmount++;

          html += '<div id="dice-'+this.dicesAmount+'" class="dice">';

          for( var i = 1, l = 7 ; i < l ; i++ ) { 

              html += '<div id="dice-'+this.dicesAmount+'-face-'+i+'" class="dice-face">';

                  for( var j = 0; j < i; j++ ){

                      html += '<div class="dice-dot dot-'+(j+1)+'-'+i+' dots-'+i+'" ></div>';

                  }

              html += '</div>';

          }

          html += '</div>';

          var container_ = document.getElementById(container);
          var container_shadows = document.getElementById(container+'-shadows');
          container_.innerHTML = container_.innerHTML + html;
          container_shadows.innerHTML = container_shadows.innerHTML + '<div id="dice-'+this.dicesAmount+'-shadow" class="dice-shadow"></div>';
      };

      app.diceShake = function(elIndex, duration, result, callback){
        var face = this.randomFace();
        var el = 'dice-'+elIndex;
        var oldDice = document.getElementById(el+'-face-'+face);
        var olderDice = oldDice;
        var newDice = oldDice;
        oldDice.style.display = 'flex';
        var i = 5;

        console.log(el, result);

        var roll = function(){
          var diagonal = Math.random()*2 > 0 ? true : false;
          olderDice = oldDice;
          oldDice = newDice;
          setTimeout(function(){
            i--;
            face = i === 0 ? result : Math.ceil(Math.random()*6);
            if(!diagonal) oldDice.style.display = 'none';
            olderDice.style.display = 'none';
            newDice = document.getElementById(el+'-face-'+face);
            newDice.style.display = 'flex';
            if(!diagonal) oldDice = newDice;
            if(i>0){
              roll();
            }else{
              if(diagonal)oldDice.style.display = 'none';
              newDice.style.display = 'flex';
              app.displayResult(elIndex, face);
              callback(elIndex);
            }
          }, duration/(i*2));
        };
        roll();
      };
      
      app.throw = function(){

          this.reset();
          this.flying = true;
          document.body.style.cursor = 'none';
        
          for( var i = 0, l = this.dicesAmount; i < l ; i++ ){

            var animationType = 'throw' + Math.ceil(Math.random()*2);
            animationType = 'throw4';

            var dice = 'dice-'+(i+1);
            document.getElementById(dice).classList.add(animationType);
            document.getElementById(dice+'-shadow').classList.add(animationType);
            var result = this.randomFace();
            this.diceShake(i+1, 600, result, function(index){
              setTimeout(function(){
                document.getElementById('dice-'+index).classList.remove(animationType);
                document.getElementById('dice-'+index+'-shadow').classList.remove(animationType);
                app.flying = false;
                document.body.style.cursor = 'pointer';
              },500);              
            });

          }
      };

      app.displayResult = function(elIndex, result){

        this.dicesResults.push(result);

        if(elIndex != this.dicesAmount)return;

        for( var i = 0, l = this.dicesResults.length; i < l ; i++ ){
           this.finalResult += this.dicesResults[i];
        }
        var finalResult = this.finalResult;
        this.resultsPool.push(finalResult);
        setTimeout(function(){
          // if( app.resultsPool.length === 1 ) document.getElementById('results-pool').innerHTML += finalResult;
          // else document.getElementById('results-pool').innerHTML += ', '+finalResult;
          document.getElementById('results-pool').innerHTML = '<span>' + app.resultsPool.join(", ") + '</span><span style="color:red;"> = ' + app.sum(app.resultsPool) + '</span>' ;
          document.getElementById('game-result').innerHTML = finalResult;
        },100);
      };

      app.createDiceIn('main-wrapper');
      app.createDiceIn('main-wrapper');

      app.throw();

      document.body.addEventListener("click", function(){
        if(!app.flying) app.throw();
      });
      
    })();
    
    // Add background noise texture
    //from http://code.tutsplus.com/tutorials/how-to-generate-noise-with-canvas--net-16556 
    (function(){
      function generateNoise(opacity) {
         if ( !!!document.createElement('canvas').getContext ) {
            return false;
         }

         var canvas = document.createElement("canvas"),
         ctx = canvas.getContext('2d'),
         x, y,
         number,
         opacity = opacity || .2;

         canvas.width = 45;
         canvas.height = 45;

         for ( x = 0; x < canvas.width; x++ ) {
            for ( y = 0; y < canvas.height; y++ ) {
               number = Math.floor( Math.random() * 60 );

               ctx.fillStyle = "rgba(" + number + "," + number + "," + number + "," + opacity + ")";
               ctx.fillRect(x, y, 1, 1);
              
            }
         }

         document.body.style.backgroundImage = "url(" + canvas.toDataURL("image/png") + ")";
      }
      generateNoise(.2); // default opacity is .2
    })();
    
    (function(){
      
      
    
    })();
    
  </script>
</body>
</html>